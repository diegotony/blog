<!doctype html><html lang=en><head><title>Pipeline para deployar a Cloudfront :: blog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="AWS Cloudfront es un servicio para servir contenido estatico o tambien llamado CDN, que resulta muy util cuando queremos deployar una web page bajo demanda con un bajo costo.Comparto un pipeline para deployar a AWS Cloudfront Usando Github Actions"><meta name=keywords content="cloudfront,github-actions"><meta name=robots content="noodp"><link rel=canonical href=https://diegotony.github.io/blog/posts/deploy-to-cloudfront-github-actions/><link rel=stylesheet href=https://diegotony.github.io/blog/assets/style.css><link rel=stylesheet href=https://diegotony.github.io/blog/assets/blue.css><link rel=apple-touch-icon href=https://diegotony.github.io/blog/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=https://diegotony.github.io/blog/img/favicon/blue.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Pipeline para deployar a Cloudfront"><meta property="og:description" content="AWS Cloudfront es un servicio para servir contenido estatico o tambien llamado CDN, que resulta muy util cuando queremos deployar una web page bajo demanda con un bajo costo.Comparto un pipeline para deployar a AWS Cloudfront Usando Github Actions"><meta property="og:url" content="https://diegotony.github.io/blog/posts/deploy-to-cloudfront-github-actions/"><meta property="og:site_name" content="blog"><meta property="og:image" content="https://diegotony.github.io/blog/"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2022-07-06 16:51:04 -0500 -0500"></head><body class=blue><div class="container full headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>blog.constant1n396.com</div></a></div></div></header><div class=content><div class=post><h1 class=post-title><a href=https://diegotony.github.io/blog/posts/deploy-to-cloudfront-github-actions/>Pipeline para deployar a Cloudfront</a></h1><div class=post-meta><span class=post-date>2022-07-06
[Updated: 2022-07-06]</span>
<span class=post-author>:: diegotony</span></div><span class=post-tags>#<a href=https://diegotony.github.io/blog/tags/github-actions/>github-actions</a>&nbsp;
#<a href=https://diegotony.github.io/blog/tags/aws/>aws</a>&nbsp;
#<a href=https://diegotony.github.io/blog/tags/cloudfront/>cloudfront</a>&nbsp;</span><div class=post-content><div><p>AWS Cloudfront es un servicio para servir contenido estatico o tambien llamado CDN, que resulta muy util cuando se desea deployar una pagina web bajo demanda con un bajo costo. A continuacion les presento un pipeline para deployar a AWS Cloudfront Usando Github Actions.</p><p>Que debe hacer nuestro pipeline:</p><ol start=0><li>Configuraciones generales del job</li><li>Check de nuestro codigo</li><li>Build de nuestra aplicacion</li><li>Setup del Role de AWS</li><li>Sync del contenido a nuestro bucket de S3</li><li>Crear una Invalidation</li><li>DONE</li></ol><h2 id=desarrollo>Desarrollo<a href=#desarrollo class=hanchor arialabel=Anchor>&#8983;</a></h2><h3 id=0-configuraciones-generales-del-job>0. Configuraciones generales del job<a href=#0-configuraciones-generales-del-job class=hanchor arialabel=Anchor>&#8983;</a></h3><p>En este paso se define que evento va hacer que el pipeline se <strong>&ldquo;encienda&rdquo;</strong>. En este caso cuando mandemos cambios directamente al branch <strong>main</strong>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>name</span>: <span style=color:#ae81ff>Deploy to Cloudfront</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>on</span>: 
</span></span><span style=display:flex><span>  <span style=color:#f92672>push</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>branches</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>main</span>
</span></span></code></pre></div><p>Despues se define el o los jobs que van correr, como por ejemplo:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>jobs</span>:  <span style=color:#75715e># &lt;= Dentro de este bloque se insertan los jobs que quiera dentro de este workflow                                     </span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>deploy</span>: <span style=color:#75715e># &lt;= Aqui se nombra el primer job</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>aws-cloudfront</span> <span style=color:#75715e># &lt;= el nombre del job</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>env</span>: <span style=color:#75715e># &lt;= Se inserta las variables de entorno que se van a ocupar de manera global, en este caso las credendiales de AWS</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>BUILD_DIR</span>: <span style=color:#ae81ff>${{ secrets.BUILD_DIR }}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>AWS_DISTRIBUTION_ID</span>:  <span style=color:#ae81ff>${{ secrets.AWS_DISTRIBUTION_ID }}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>AWS_S3_BUCKET</span>: <span style=color:#ae81ff>${{ secrets.AWS_S3_BUCKET }}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>runs-on</span>: <span style=color:#ae81ff>ubuntu-latest</span> <span style=color:#75715e># &lt;= En que sistema operativo se va a correr el job, en este ubuntu, que es ademas el mas barato </span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>steps</span>:
</span></span></code></pre></div><h3 id=1-check-de-nuestro-codigo>1. Check de nuestro codigo<a href=#1-check-de-nuestro-codigo class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Aqui lo que hace basicamente es descargar nuestro codigo al job</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Check out code  </span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>actions/checkout@v3</span>
</span></span></code></pre></div><h3 id=2-build-de-nuestra-aplicacion>2. Build de nuestra aplicacion<a href=#2-build-de-nuestra-aplicacion class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Para este pagina web se usa <strong>NodeJS</strong> como lenguaje de programacion, por lo que se tiene que instalar dentro del job, se lo hace de la siguiente manera.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>    - <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>actions/setup-node@v3</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>node-version</span>: <span style=color:#ae81ff>18</span>
</span></span></code></pre></div><p>Se procede a hacer una instalacion de las dependencias.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Install Dependencies</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>run</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        </span>        <span style=color:#ae81ff>npm install</span>
</span></span></code></pre></div><p>Se hace un build de la aplicacion, varia mucho del framework, lo que se usa para el ejemplo es <strong>NextJS</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Build NextJs App</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>run</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        </span>        <span style=color:#ae81ff>npm run build --if-present </span>
</span></span></code></pre></div><p>| Algo importante es que a veces sabe dar error el el build cuando se genera los proyectos por medio de CLI&rsquo;s del framework, como por ejemplo angular-cli o react-cli, por lo que se necesita instalar este CLI antes de hacer el build de manera global, como por ejemplo <code>npm install -g @angular/cli</code></p><h3 id=3-setup-del-role-de-aws>3. Setup del Role de AWS<a href=#3-setup-del-role-de-aws class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Se hace la configuracion del Role de AWS para desplegar el proyecto por medio de GitHub Actions, a mi parecer es la manera mas segura, <a href=https://github.com/aws-actions/configure-aws-credentials#assuming-a-role>aqui</a> te dejo como configurar el Role o en tal caso que quieras hacerlo con crendenciales presiona <a href=https://github.com/aws-actions/configure-aws-credentials>aqui</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Configure AWS Role</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>aws-actions/configure-aws-credentials@v1</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>role-to-assume</span>: <span style=color:#ae81ff>${{ secrets.AWS_ACCESS_ROLE }}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>role-session-name</span>: <span style=color:#ae81ff>github-action-job</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>role-duration-seconds</span>: <span style=color:#ae81ff>900</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>aws-region</span>: <span style=color:#ae81ff>us-east-1</span>
</span></span></code></pre></div><p>Algo importante a mencionar es que si usaste la configuracion con el Role, debes agregar el ARN del Roles en los SECRETS de GitHub Actions, dentro del step debes de poner este bloque.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>    <span style=color:#f92672>permissions</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>id-token</span>: <span style=color:#ae81ff>write</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>contents</span>: <span style=color:#ae81ff>read</span>
</span></span></code></pre></div><p>Finalmente se veria asi</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Configure AWS Role</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>aws-actions/configure-aws-credentials@v1</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>permissions</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>id-token</span>: <span style=color:#ae81ff>write</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>contents</span>: <span style=color:#ae81ff>read</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>role-to-assume</span>: <span style=color:#ae81ff>${{ secrets.AWS_ACCESS_ROLE }}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>role-session-name</span>: <span style=color:#ae81ff>github-action-job</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>role-duration-seconds</span>: <span style=color:#ae81ff>900</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>aws-region</span>: <span style=color:#ae81ff>us-east-1</span>
</span></span></code></pre></div><h3 id=4-sync-del-contenido-a-nuestro-bucket-de-s3>4. Sync del contenido a nuestro bucket de S3<a href=#4-sync-del-contenido-a-nuestro-bucket-de-s3 class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Ahora se sube el build dentro del bucket de S3, para eso se necesita el URL del Bucket, por lo que el url se veria mas o menos asi <code>s3://my-source-bucket</code>, algo mas para agregar es que en la etapa de build, no necesariamente siempre va a generar el el diretorio <code>build/</code> como resultado del el build, en alguno casos tambien se same llamar <code>dist/</code> o <code>out/</code>, por lo que te recomiendo correr en local el comando para que sepas que directorio vas a subir. Te recomiendo poner el nombre de bucket en los SECRETS de GitHub Actions.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Sync S3 Bucket</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>run</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        echo &#34;Save in S3 Bucket&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        aws s3 sync public $AWS_S3_BUCKET</span>        
</span></span></code></pre></div><h3 id=5-crear-una-invalidation>5. Crear una Invalidation<a href=#5-crear-una-invalidation class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Y por ultimo se procede a invalidar la version subida en <strong>Cloudfront</strong>, <em>Por que es necesario esto?</em> Ya que cada vez que se despliega una version nueva de la pagina web, Cloudfront lo guarda en cache dentro de su servicio, para optimizar la cargar del sitio, por lo que se necesita decirle que tome la nueva version en el bucket, por lo que se invalida la que previamente fue subida, y se valida la actual, para esto se necesita el ID del Cloudfront.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Deploy Invalidation </span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>run</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        echo &#34;Deploy to Cloudfront&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        aws cloudfront create-invalidation --paths /* --distribution-id $AWS_DISTRIBUTION_ID</span>        
</span></span></code></pre></div><p>En caso que estes familiarizado con los Reusable Jobs en Github puedes hecharle un ojo a este <a href=https://github.com/diegotony/gh-pipelines/blob/main/.github/workflows/aws-cloudfront.yml>job</a>.</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://diegotony.github.io/blog/posts/github-actions-part-one/><span class=button__icon>←</span>
<span class=button__text>Mis Actions Favoritos Parte 1</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2022 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=https://diegotony.github.io/blog/assets/main.js></script>
<script src=https://diegotony.github.io/blog/assets/prism.js></script>
<script src=https://diegotony.github.io/blog/assets/languageSelector.js></script></div></body></html>